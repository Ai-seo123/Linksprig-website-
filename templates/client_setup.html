{% extends "base.html" %}
{% block title %}Client Setup - LinkSprig{% endblock %}

{% block content %}
<style>
    /* Helper class for the copy button */
    .copy-api-key {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1rem;
        background-color: var(--color-background);
        border: 1px solid var(--color-border);
        border-radius: var(--border-radius);
        font-family: monospace;
        font-size: 1rem;
        color: var(--color-text-secondary);
    }
    .api-key-text {
        flex-grow: 1;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    .status-badge {
        font-size: 0.9rem;
        font-weight: 600;
        padding: 0.25em 0.6em;
        border-radius: 0.25rem;
    }
    .status-badge-success {
        color: var(--color-success);
        background-color: #e6f6e9;
    }
    .status-badge-danger {
        color: var(--color-danger);
        background-color: #fdecea;
    }
    html.dark .status-badge-success {
        background-color: #1a3c22;
    }
    html.dark .status-badge-danger {
        background-color: #392224;
    }
</style>

<div class="container">
    <div class="card">
        <div class="card-header">
            <h4><i class="fas fa-desktop"></i> Local Client Setup</h4>
        </div>
        <div class="card-body">
            <div class="alert alert-info">
                <h5><i class="fas fa-info-circle"></i> Why do I need a local client?</h5>
                <p>LinkedIn automation runs in a real browser to keep your account safe. The local client runs on your computer, connects securely to this dashboard, and polls for new tasks (like sending messages or connection requests) to execute on your behalf.</p>
            </div>

            <div class="page-grid mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-satellite-dish"></i> Client Status</h5>
                    </div>
                    <div class="card-body text-center">
                        <div id="client-status-icon" class="fa-3x mb-2">
                            <i class="fas fa-circle-notch fa-spin text-muted"></i>
                        </div>
                        <p id="client-status-text" style="font-weight: 600;" class="mb-1">Checking...</p>
                        <small id="client-status-last-seen" class="text-muted">Waiting for first check</small>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-download"></i> Step 1: Download Client</h5>
                    </div>
                    <div class="card-body text-center">
                        <p>Download the local client for your computer. (Only Windows is currently supported).</p>
                        <button class="btn btn-primary btn-lg btn-block mb-2" onclick="downloadClient()">
                            <i class="fab fa-windows me-2"></i> Download for Windows
                        </button>
                        <small class="text-muted">macOS & Linux coming soon</small>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-cogs"></i> Step 2: Setup Instructions</h5>
                </div>
                <div class="card-body">
                    <div class="page-grid">
                        <div>
                            <ol style="padding-left: 1.5rem; line-height: 2;">
                                <li><strong>Download & Install:</strong> Run the installer you just downloaded.</li>
                                <li><strong>Run Client:</strong> Open the LinkSprig client application.</li>
                                <li><strong>Enter Credentials:</strong> In the client's settings, enter your LinkedIn Email & Password.</li>
                                <li><strong>Enter API Key:</strong> Copy your unique API key from the box on the right and paste it into the client.</li>
                                <li><strong>Start Client:</strong> Click "Save & Start" in the client.</li>
                                <li><strong>Check Status:</strong> Come back here. The status above should change to <span class="status-badge status-badge-success">Connected</span>.</li>
                            </ol>
                        </div>
                        <div>
                            <h6>Your Unique API Key</h6>
                            <p class="text-muted"><small>This key securely links your local client to your account. Keep it private.</small></p>
                            <div class="copy-api-key">
                                <span class="api-key-text" id="api-key-display">{{ api_key or 'API_KEY_NOT_FOUND' }}</span>
                                <button class="btn btn-secondary btn-sm" onclick="copyToClipboard('#api-key-display')">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function showAlert(type, message) {
    // (This function is from your file, left unchanged)
    const category = (type === 'danger') ? 'error' : type;
    const icon = {
        'success': 'check-circle',
        'error': 'exclamation-triangle',
        'info': 'info-circle'
    }[category];

    const alertDiv = document.createElement('div');
    alertDiv.className = `flash-message flash-${category}`;
    alertDiv.innerHTML = `
        <i class="fas fa-fw fa-${icon}"></i>
        <span>${message}</span>
        <button class="flash-close" onclick="this.parentElement.remove()">&times;</button>`;
    
    const container = document.querySelector('.flash-messages');
    if (container) {
        container.appendChild(alertDiv);
    } else {
        document.body.appendChild(alertDiv);
    }
    
    setTimeout(() => {
        $(alertDiv).fadeOut('slow', () => $(alertDiv).remove());
    }, 5000);
}

function copyToClipboard(elementId) {
    const textToCopy = document.querySelector(elementId).innerText;
    navigator.clipboard.writeText(textToCopy).then(() => {
        showAlert('success', 'API Key copied to clipboard!');
    }, (err) => {
        showAlert('danger', 'Failed to copy text.');
    });
}

function downloadClient() {
    const windowsUrl = '#'; // <-- REPLACE '#' WITH YOUR ACTUAL DOWNLOAD URL
    
    if (windowsUrl === '#') {
        showAlert('info', 'Windows client download is not yet available. Please check back soon.');
    } else {
        window.open(windowsUrl, '_blank');
    }
}

function formatTimeAgo(isoString) {
    if (!isoString) return 'never';
    
    const date = new Date(isoString);
    const seconds = Math.floor((new Date() - date) / 1000);
    
    let interval = seconds / 31536000;
    if (interval > 1) return Math.floor(interval) + " years ago";
    interval = seconds / 2592000;
    if (interval > 1) return Math.floor(interval) + " months ago";
    interval = seconds / 86400;
    if (interval > 1) return Math.floor(interval) + " days ago";
    interval = seconds / 3600;
    if (interval > 1) return Math.floor(interval) + " hours ago";
    interval = seconds / 60;
    if (interval > 1) return Math.floor(interval) + " minutes ago";
    
    if (seconds < 10) return "just now";
    return Math.floor(seconds) + " seconds ago";
}

function checkClientStatus() {
    const iconEl = document.getElementById('client-status-icon');
    const textEl = document.getElementById('client-status-text');
    const lastSeenEl = document.getElementById('client-status-last-seen');

    fetch('/api/client-status')
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data.active) {
                // Client is connected and recently seen
                iconEl.innerHTML = '<i class="fas fa-check-circle text-success"></i>';
                textEl.innerHTML = 'Connected';
                lastSeenEl.innerText = `Last seen: ${formatTimeAgo(data.last_seen)}`;
            } else if (data.registered && !data.active) {
                // Client is registered but not seen recently
                iconEl.innerHTML = '<i class="fas fa-exclamation-triangle text-warning"></i>';
                textEl.innerHTML = 'Disconnected';
                lastSeenEl.innerText = `Last seen: ${formatTimeAgo(data.last_seen)}`;
            } else {
                // Client has never connected
                iconEl.innerHTML = '<i class="fas fa-times-circle text-danger"></i>';
                textEl.innerHTML = 'Not Connected';
                lastSeenEl.innerText = 'No client activity detected.';
            }
        })
        .catch(error => {
            console.error('Error checking client status:', error);
            iconEl.innerHTML = '<i class="fas fa-exclamation-circle text-danger"></i>';
            textEl.innerHTML = 'Error';
            lastSeenEl.innerText = 'Could not check status.';
        });
}

// Run on page load
document.addEventListener('DOMContentLoaded', () => {
    checkClientStatus();
    
    // Set up a poller to check the status every 10 seconds
    setInterval(checkClientStatus, 10000);
});
</script>
{% endblock %}